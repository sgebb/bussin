@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inherits LayoutComponentBase
@implements IDisposable
@inject IPreferencesService PreferencesService
@inject NavigationStateService NavState
@inject AuthenticationStateProvider AuthStateProvider

@inject BackgroundSearchService BackgroundSearch

<CascadingValue Value="@_isInitialized" Name="LayoutInitialized">
    <AuthorizeView>
        <Authorized>
            @if (_isInitialized)
            {
                <div class="page" data-theme="@(_isDarkMode ? "dark" : "light")">
                    <div class="sidebar">
                        <NavMenu IsDarkMode="@_isDarkMode" OnToggleDarkMode="@ToggleDarkMode" />
                    </div>

                    <main>
                        <article class="content">
                            @Body
                        </article>
                    </main>
                </div>

                <div data-theme="@(_isDarkMode ? "dark" : "light")">
                    <BuildInfo />
                    <NotificationsSidebar />
                    <TasksSidebar OnViewSearchResults="@HandleViewSearchResults" />
                </div>

                <!-- Support Modal (rendered outside .page for proper z-index) -->
                @if (NavState.ShowSupportModal)
                {
                    <div class="modal show d-block" tabindex="-1" data-theme="@(_isDarkMode ? "dark" : "light")" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999;" @onclick="NavState.HideSupportModal">
                        <div class="modal-dialog modal-dialog-centered modal-sm">
                            <div class="modal-content" @onclick:stopPropagation="true">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="bi bi-heart-fill text-danger me-2"></i>Support bussin</h5>
                                    <button type="button" class="btn-close" @onclick="NavState.HideSupportModal"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="mb-3">Enjoying bussin? Give it a star or make a Github Issue if you have a request!</p>
                                    <div class="d-flex flex-column gap-2">
                                        <a href="https://github.com/sgebb/bussin" target="_blank" rel="noopener" class="btn btn-github w-100">
                                            <i class="bi bi-github me-1"></i> GitHub
                                        </a>
                                        <a href="https://buymeacoffee.com/sgebb" target="_blank" rel="noopener" class="btn btn-bmc w-100">
                                            <i class="bi bi-cup-hot-fill me-1"></i> Buy me a coffee
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Delete Folder Confirmation Modal (rendered outside .page for proper z-index) -->
                @if (NavState.ShowDeleteFolderModal)
                {
                    <div class="modal show d-block" tabindex="-1" data-theme="@(_isDarkMode ? "dark" : "light")" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999;" @onclick="NavState.HideDeleteFolderModal">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content" @onclick:stopPropagation="true">
                                <div class="modal-header">
                                    <h5 class="modal-title">Delete Folder</h5>
                                    <button type="button" class="btn-close" @onclick="NavState.HideDeleteFolderModal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Are you sure you want to delete the folder <strong>@NavState.FolderNameToDelete</strong>?</p>
                                    @if (NavState.FolderNamespaceCount > 0)
                                    {
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle"></i> This folder contains <strong>@NavState.FolderNamespaceCount</strong> namespace(s). They will be moved to the default "Namespaces" folder.
                                        </div>
                                    }
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @onclick="NavState.HideDeleteFolderModal">Cancel</button>
                                    <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteFolder">Delete Folder</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
        </Authorized>
        <Authorizing>
            <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Authenticating...</span>
                </div>
            </div>
        </Authorizing>
        <NotAuthorized>
            @Body
        </NotAuthorized>
    </AuthorizeView>
</CascadingValue>

@code {
    private bool _isDarkMode;
    private bool _isInitialized;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to auth state changes to handle post-login initialization
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
        NavState.OnDeleteModalChange += OnDeleteModalChange;
        NavState.OnSupportModalChange += OnSupportModalChange;
        
        await InitializeIfAuthenticatedAsync();
    }

    private void OnDeleteModalChange()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnSupportModalChange()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task ConfirmDeleteFolder()
    {
        await NavState.ConfirmDeleteFolderAsync();
    }

    private void HandleViewSearchResults(SearchOperation operation)
    {
        BackgroundSearch.RequestViewResults(operation);
    }

    private async void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        // Re-initialize when auth state changes (e.g., after login redirect)
        await InitializeIfAuthenticatedAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task InitializeIfAuthenticatedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            // Load preferences and initialize nav state
            var prefs = await PreferencesService.LoadPreferencesAsync();
            _isDarkMode = prefs.DarkMode;
            
            await NavState.InitializeAsync();
            _isInitialized = true;
        }
        else
        {
            // For non-authenticated users, just load preferences
            var prefs = await PreferencesService.LoadPreferencesAsync();
            _isDarkMode = prefs.DarkMode;
            _isInitialized = true;
        }
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        
        var prefs = await PreferencesService.LoadPreferencesAsync();
        prefs.DarkMode = _isDarkMode;
        await PreferencesService.SavePreferencesAsync(prefs);
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
        NavState.OnDeleteModalChange -= OnDeleteModalChange;
        NavState.OnSupportModalChange -= OnSupportModalChange;
    }
}
