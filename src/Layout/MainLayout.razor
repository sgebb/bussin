@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inherits LayoutComponentBase
@implements IDisposable
@inject IPreferencesService PreferencesService
@inject NavigationStateService NavState
@inject AuthenticationStateProvider AuthStateProvider

<CascadingValue Value="@_isInitialized" Name="LayoutInitialized">
    <AuthorizeView>
        <Authorized>
            @if (_isInitialized)
            {
                <div class="page" data-theme="@(_isDarkMode ? "dark" : "light")">
                    <div class="sidebar">
                        <NavMenu IsDarkMode="@_isDarkMode" OnToggleDarkMode="@ToggleDarkMode" />
                    </div>

                    <main>
                        <article class="content">
                            @Body
                        </article>
                    </main>
                </div>

                <ToastNotification />
                <BuildInfo />
            }
            else
            {
                <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
        </Authorized>
        <Authorizing>
            <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Authenticating...</span>
                </div>
            </div>
        </Authorizing>
        <NotAuthorized>
            @Body
        </NotAuthorized>
    </AuthorizeView>
</CascadingValue>

@code {
    private bool _isDarkMode;
    private bool _isInitialized;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to auth state changes to handle post-login initialization
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
        
        await InitializeIfAuthenticatedAsync();
    }

    private async void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        // Re-initialize when auth state changes (e.g., after login redirect)
        await InitializeIfAuthenticatedAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task InitializeIfAuthenticatedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            // Load preferences and initialize nav state
            var prefs = await PreferencesService.LoadPreferencesAsync();
            _isDarkMode = prefs.DarkMode;
            
            await NavState.InitializeAsync();
            _isInitialized = true;
        }
        else
        {
            // For non-authenticated users, just load preferences
            var prefs = await PreferencesService.LoadPreferencesAsync();
            _isDarkMode = prefs.DarkMode;
            _isInitialized = true;
        }
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        
        var prefs = await PreferencesService.LoadPreferencesAsync();
        prefs.DarkMode = _isDarkMode;
        await PreferencesService.SavePreferencesAsync(prefs);
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
    }
}
