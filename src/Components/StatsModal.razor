@using Bussin.Models
@using Azure.Core

@if (IsVisible)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5); z-index: 1050;" @onclick="Close">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-bar-chart-line me-2"></i>
                        Message Statistics
                    </h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Scope/Entity Selection Row -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Scope</label>
                            <select class="form-select" @bind="SelectedScope" @bind:after="OnSelectionChanged">
                                <option value="namespace">Entire Namespace</option>
                                @if (hasQueues)
                                {
                                    <option value="queue">Specific Queue</option>
                                }
                                @if (hasTopics)
                                {
                                    <option value="topic">Specific Topic</option>
                                }
                            </select>
                        </div>
                        
                        @if (SelectedScope == "queue" && hasQueues)
                        {
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Queue</label>
                                <select class="form-select" @bind="selectedEntityName" @bind:after="OnSelectionChanged">
                                    <option value="">-- Select a queue --</option>
                                    @foreach (var queue in Queues)
                                    {
                                        <option value="@queue.Name">@queue.Name</option>
                                    }
                                </select>
                            </div>
                        }
                        else if (SelectedScope == "topic" && hasTopics)
                        {
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Topic</label>
                                <select class="form-select" @bind="selectedEntityName" @bind:after="OnSelectionChanged">
                                    <option value="">-- Select a topic --</option>
                                    @foreach (var topic in Topics)
                                    {
                                        <option value="@topic.Name">@topic.Name</option>
                                    }
                                </select>
                            </div>
                        }
                    </div>

                    <!-- Stats Panel with key to force re-render -->
                    <StatsPanel @key="statsPanelKey"
                                NamespaceInfo="@NamespaceInfo"
                                EntityName="@GetEntityNameForStats()"
                                EntityType="@GetEntityTypeForStats()"
                                AutoLoad="true" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public ServiceBusNamespaceInfo? NamespaceInfo { get; set; }
    [Parameter] public List<ServiceBusQueueInfo> Queues { get; set; } = new();
    [Parameter] public List<ServiceBusTopicInfo> Topics { get; set; } = new();

    private string SelectedScope { get; set; } = "namespace";
    private string selectedEntityName = "";
    private int statsPanelKey = 0; // Used to force StatsPanel to re-render
    
    private bool hasQueues => Queues.Any();
    private bool hasTopics => Topics.Any();

    private void OnSelectionChanged()
    {
        // When scope changes to namespace, clear entity name
        if (SelectedScope == "namespace")
        {
            selectedEntityName = "";
        }
        
        // Increment key to force StatsPanel to re-create and auto-load
        statsPanelKey++;
    }

    private string? GetEntityNameForStats()
    {
        if (SelectedScope == "namespace")
            return null;
        
        return string.IsNullOrEmpty(selectedEntityName) ? null : selectedEntityName;
    }

    private string? GetEntityTypeForStats()
    {
        return SelectedScope switch
        {
            "queue" when !string.IsNullOrEmpty(selectedEntityName) => "queue",
            "topic" when !string.IsNullOrEmpty(selectedEntityName) => "topic",
            _ => null
        };
    }

    private async Task Close()
    {
        SelectedScope = "namespace";
        selectedEntityName = "";
        statsPanelKey = 0;
        await OnClose.InvokeAsync();
    }
}
