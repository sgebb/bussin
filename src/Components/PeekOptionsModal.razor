@using Bussin.Models

<style>
    /* Hide number input spinners */
    .no-spinners::-webkit-inner-spin-button, 
    .no-spinners::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    .no-spinners {
      -moz-appearance: textfield;
    }
</style>

@if (IsVisible)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5); z-index: 1050;" @onmouseup="HandleBackdropMouseUp">
        <div class="modal-dialog" @onmousedown="HandleContentMouseDown" @onmousedown:stopPropagation="true">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i> Peek with Options
                    </h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 mb-3">
                        <div class="col-sm-6">
                            <label for="maxCount" class="form-label">Max Messages</label>
                            <input type="number" class="form-control no-spinners" id="maxCount" value="@maxCount" @oninput="OnMaxCountChanged" min="1" max="250">
                            @if (validationError != null)
                            {
                                <div class="invalid-feedback d-block">@validationError</div>
                            }
                        </div>
                        <div class="col-sm-6" style="@(peekFromNewest ? "visibility: hidden;" : "")">
                            <label for="fromSequence" class="form-label">From Sequence Number</label>
                            <input type="number" 
                                   class="form-control no-spinners" 
                                   id="fromSequence" 
                                   @bind="fromSequenceNumber" 
                                   min="0" 
                                   disabled="@peekFromNewest">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="peekFromNewest" checked="@peekFromNewest" @onchange="OnPeekFromNewestChanged">
                            <label class="form-check-label" for="peekFromNewest">
                                Reverse peek (LIFO)
                                <i class="bi bi-info-circle text-muted" 
                                   style="cursor: help;" 
                                   title="Attempts to peek the newest messages (LIFO - Last In First Out). Note: This is a best-effort calculation based on message counts."></i>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="bodyFilter" class="form-label">
                            Find String in Body
                            <i class="bi bi-info-circle text-muted" 
                               style="cursor: help;" 
                               title="Filters messages containing this text in the body. Will search through up to 10,000 messages to find matches. Leave empty to peek all messages."></i>
                        </label>
                        <input type="text" class="form-control" id="bodyFilter" value="@bodyFilter" @oninput="OnBodyFilterChanged" placeholder="Enter search text...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ExecutePeek" disabled="@(validationError != null)">
                        <i class="bi bi-search"></i> Peek
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<PeekOptions> OnPeek { get; set; }
    [Parameter] public PeekOptions? InitialOptions { get; set; }

    private int maxCount = 50;
    private long fromSequenceNumber = 0;
    private string bodyFilter = "";
    private bool peekFromNewest = false;
    private string? validationError = null;
    private bool mouseDownInContent = false;

    protected override void OnParametersSet()
    {
        // Reset to defaults or initial options when modal opens
        if (IsVisible)
        {
            if (InitialOptions != null)
            {
                maxCount = InitialOptions.MaxCount;
                fromSequenceNumber = InitialOptions.FromSequenceNumber;
                bodyFilter = InitialOptions.BodyFilter;
                peekFromNewest = InitialOptions.PeekFromNewest;
            }
            else
            {
                maxCount = 50;
                fromSequenceNumber = 0;
                bodyFilter = "";
                peekFromNewest = false;
            }
            validationError = null;
            mouseDownInContent = false;
        }
    }

    private int GetFilterMaxMessages()
    {
        return string.IsNullOrWhiteSpace(bodyFilter) ? maxCount : 50;
    }

    private void OnMaxCountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
        {
            maxCount = value;
            ValidateMaxCount();
        }
    }

    private void OnBodyFilterChanged(ChangeEventArgs e)
    {
        bodyFilter = e.Value?.ToString() ?? "";
        ValidateMaxCount(); // Re-validate when filter changes
    }

    private void OnPeekFromNewestChanged(ChangeEventArgs e)
    {
        peekFromNewest = (bool)(e.Value ?? false);
        if (peekFromNewest)
        {
            fromSequenceNumber = 0; // Reset when switching to reverse mode
        }
    }

    private void ValidateMaxCount()
    {
        if (maxCount < 1)
        {
            validationError = "Max messages must be at least 1";
        }
        else if (maxCount > 250)
        {
            validationError = "Max messages must be 250 or less (Azure Service Bus limit)";
        }
        else
        {
            validationError = null;
        }
    }

    private void HandleContentMouseDown()
    {
        mouseDownInContent = true;
    }

    private void HandleBackdropMouseUp()
    {
        // Only close if the mouse down didn't happen in the content
        if (!mouseDownInContent)
        {
            _ = Close();
        }
        mouseDownInContent = false;
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private async Task ExecutePeek()
    {
        // Validate maxCount
        ValidateMaxCount();
        if (validationError != null)
        {
            return;
        }
        
        // Clamp values
        maxCount = Math.Clamp(maxCount, 1, 250);
        fromSequenceNumber = Math.Max(0, fromSequenceNumber);
        
        var options = new PeekOptions
        {
            MaxCount = maxCount,
            FromSequenceNumber = peekFromNewest ? 0 : fromSequenceNumber,  // Will be calculated later if peekFromNewest is true
            BodyFilter = bodyFilter?.Trim() ?? "",
            PeekFromNewest = peekFromNewest
        };
        
        await OnPeek.InvokeAsync(options);
    }
}


