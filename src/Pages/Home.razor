@page "/"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.JSInterop
@using System.Text.Json
@inject IAuthenticationService AuthService
@inject IAzureResourceService ResourceService
@inject IAccessTokenProvider TokenProvider
@inject NavigationManager Navigation
@inject NavigationStateService NavState
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime

<PageTitle>bussin</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="container-fluid p-4">
            @if (!hasArmPermission && !isGrantingArmConsent)
            {
                <div class="alert alert-warning">
                    <h5><i class="bi bi-exclamation-triangle"></i> Permission Required</h5>
                    <p class="mb-3">
                        <strong>To see your Service Bus namespaces here, you need to grant Azure Management API permission.</strong>
                        This allows bussin to read and list your Service Bus namespaces across your Azure subscriptions.
                    </p>
                    <p class="mb-3">
                        <strong>What we use it for:</strong>
                    </p>
                    <ul class="mb-3">
                        <li>List all Service Bus namespaces in your tenant</li>
                        <li>Read queue/topic/subscription metadata (message counts, status, etc.)</li>
                        <li>Nothing else - we never create, modify, or delete any Azure resources</li>
                    </ul>
                    @if (!string.IsNullOrEmpty(consentErrorMessage))
                    {
                        <div class="alert alert-danger mb-3">
                            <i class="bi bi-exclamation-circle"></i> @consentErrorMessage
                            @if (requiresRelogin)
                            {
                                <div class="mt-2">
                                    <a href="authentication/logout" class="btn btn-danger btn-sm">
                                        <i class="bi bi-box-arrow-right"></i> Sign Out and Sign In Again
                                    </a>
                                </div>
                            }
                        </div>
                    }
                    @if (!requiresRelogin)
                    {
                        <button class="btn btn-warning" @onclick="GrantArmConsent" disabled="@isGrantingArmConsent">
                            <i class="bi bi-check-circle"></i> Grant Azure Management API Permission
                        </button>
                    }
                </div>
            }
            else if (isGrantingArmConsent)
            {
                <div class="alert alert-info">
                    <div class="d-flex align-items-center gap-2">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Opening consent popup...</span>
                    </div>
                </div>
            }
            

            @if (hasArmPermission)
            {
                <div class="row justify-content-center mb-4">
                    <div class="col-lg-6">
                        <div class="position-relative">
                            <input type="text" class="form-control form-control-lg text-center" placeholder="Search namespaces..." 
                                   @bind="searchTerm" @bind:event="oninput" />
                            @if (isRefreshing)
                            {
                                <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                                    <div class="spinner-border spinner-border-sm text-muted" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                @if (isRefreshing && namespaces.Count == 0)
                {
                    <div class="text-center mb-3">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                }
                else if (namespaces.Count > 0)
                {
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3">
                        @foreach (var ns in FilteredNamespaces)
                        {
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 namespace-card" style="cursor: pointer;">
                                    <button class="favorite-btn @(NavState.IsFavorite(ns.FullyQualifiedNamespace) ? "favorited" : "not-favorited")" 
                                            @onclick="async () => await ToggleFavorite(ns.FullyQualifiedNamespace)" 
                                            @onclick:stopPropagation="true"
                                            title="@(NavState.IsFavorite(ns.FullyQualifiedNamespace) ? "Remove from favorites" : "Add to favorites")">
                                        <i class="bi @(NavState.IsFavorite(ns.FullyQualifiedNamespace) ? "bi-star-fill" : "bi-star")"></i>
                                    </button>
                                    <div class="card-body" @onclick="() => NavigateToExplorer(ns)">
                                        <h5 class="card-title">@ns.Name</h5>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                <strong>Subscription:</strong> @ns.SubscriptionName<br />
                                                <strong>Resource Group:</strong> @ns.ResourceGroup<br />
                                                <strong>Location:</strong> @ns.Location<br />
                                                <strong>Tenant:</strong> @ns.TenantId
                                            </small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (!isRefreshing)
                {
                    @* No namespaces found - show helpful guidance *@
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="bi bi-search"></i> No Service Bus Namespaces Found</h5>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">We couldn't find any Service Bus namespaces in your Azure subscriptions. This could be because:</p>
                                    
                                    <div class="accordion accordion-flush" id="noNamespacesHelp">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#noNsReason1">
                                                    <i class="bi bi-collection me-2"></i> No namespaces exist in your subscriptions
                                                </button>
                                            </h2>
                                            <div id="noNsReason1" class="accordion-collapse collapse" data-bs-parent="#noNamespacesHelp">
                                                <div class="accordion-body">
                                                    <p>If you haven't created any Service Bus namespaces yet, you'll need to create one in the Azure portal first.</p>
                                                    <a href="https://portal.azure.com/#create/Microsoft.ServiceBus" target="_blank" class="btn btn-outline-primary btn-sm">
                                                        <i class="bi bi-plus-circle"></i> Create Service Bus Namespace in Azure
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#noNsReason2">
                                                    <i class="bi bi-shield-lock me-2"></i> Missing permissions to view namespaces
                                                </button>
                                            </h2>
                                            <div id="noNsReason2" class="accordion-collapse collapse" data-bs-parent="#noNamespacesHelp">
                                                <div class="accordion-body">
                                                    <p>To list Service Bus namespaces, you need the <code>Microsoft.ServiceBus/namespaces/read</code> permission.</p>
                                                    <p><strong>Required Azure RBAC role (at subscription or resource group level):</strong></p>
                                                    <ul class="mb-3">
                                                        <li><strong>Reader</strong> - Can view all resources</li>
                                                        <li><strong>Contributor</strong> - Can manage all resources</li>
                                                        <li><strong>Owner</strong> - Full access including role assignments</li>
                                                    </ul>
                                                    <div class="alert alert-warning mb-0">
                                                        <i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> Data plane roles like "Azure Service Bus Data Receiver" or "Azure Service Bus Data Sender" do <em>not</em> include permission to list namespaces. You need a Reader/Contributor role at the subscription or resource group level.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#noNsReason3">
                                                    <i class="bi bi-building me-2"></i> Namespace is in a different Azure AD tenant
                                                </button>
                                            </h2>
                                            <div id="noNsReason3" class="accordion-collapse collapse" data-bs-parent="#noNamespacesHelp">
                                                <div class="accordion-body">
                                                    <p>If the namespace belongs to a different Azure AD tenant, you'll need to sign out and sign in with an account from that tenant.</p>
                                                    <a href="/user" class="btn btn-outline-secondary btn-sm">
                                                        <i class="bi bi-person"></i> Go to Account Settings
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr />
                                    <p class="mb-2"><i class="bi bi-lightbulb"></i> <strong>Tip:</strong> If you know your namespace URL, you can add it as a favorite and access it directly:</p>
                                    <p class="text-muted small mb-0">
                                        Navigate directly to: <code>/explorer?namespace=YOUR-NAMESPACE.servicebus.windows.net</code>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3">
                    <strong>Error:</strong> @errorMessage
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="jumbotron">
                        <h1 class="display-4">Welcome to bussin</h1>
                        <p class="lead">A zero-backend tool for exploring and managing Azure Service Bus.</p>
                        <hr class="my-4">
                        <p>Sign in with your Azure account to get started.</p>
                        <a class="btn btn-primary btn-lg" href="authentication/login" role="button">Sign In</a>
                        
                        <div class="mt-4">
                            <SecurityInfoCard />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

<BuildInfo />

@code {
    private Dictionary<string, ServiceBusNamespaceInfo> namespaceDict = new();
    private List<ServiceBusNamespaceInfo> namespaces => namespaceDict.Values.OrderBy(ns => ns.Name).ToList();
    private bool isRefreshing = false;
    private string? errorMessage;
    private string searchTerm = "";
    private CancellationTokenSource? _loadCts;
    private bool hasArmPermission = false;
    private bool isGrantingArmConsent = false;
    private string? consentErrorMessage = null;
    private bool requiresRelogin = false;

    private IEnumerable<ServiceBusNamespaceInfo> FilteredNamespaces => 
        string.IsNullOrWhiteSpace(searchTerm) 
            ? namespaces 
            : namespaces.Where(ns => 
                ns.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (ns.SubscriptionName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                ns.ResourceGroup.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            // NavState is initialized by MainLayout, no need to duplicate
            await CheckArmPermission();
            if (hasArmPermission)
            {
                _ = LoadNamespacesAsync();
            }
        }
    }

    private async Task CheckArmPermission()
    {
        try
        {
            var result = await TokenProvider.RequestAccessToken(new AccessTokenRequestOptions
            {
                Scopes = ["https://management.azure.com/user_impersonation"]
            });

            hasArmPermission = result.Status != AccessTokenResultStatus.RequiresRedirect;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking ARM permission: {ex.Message}");
            hasArmPermission = false;
        }
    }

    private async Task GrantArmConsent()
    {
        isGrantingArmConsent = true;
        consentErrorMessage = null;
        requiresRelogin = false;
        StateHasChanged();

        try
        {
            var clientId = Configuration["AzureAd:ClientId"];
            var authority = Configuration["AzureAd:Authority"];
            
            // Get the current user's username to use as a login hint
            var currentUser = await AuthService.GetUserNameAsync();
            
            await JSRuntime.InvokeVoidAsync("eval", $@"
                window.msalConfig = {{
                    clientId: '{clientId}',
                    authority: '{authority}'
                }};
            ");

            // Pass the login hint to help MSAL identify the correct account
            var result = await JSRuntime.InvokeAsync<JsonElement>("msalHelper.acquireTokenPopup", 
                "https://management.azure.com/user_impersonation",
                currentUser);

            if (result.TryGetProperty("success", out var success) && success.GetBoolean())
            {
                Console.WriteLine("✓ ARM consent granted successfully - reloading page to refresh tokens");
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
                return;
            }
            else if (result.TryGetProperty("requiresRefresh", out var refreshRequired) && refreshRequired.GetBoolean())
            {
                // Multiple matching tokens error - page refresh fixes this
                Console.WriteLine("Token cache conflict detected - auto-refreshing page");
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
                return;
            }
            else if (result.TryGetProperty("requiresRelogin", out var reloginRequired) && reloginRequired.GetBoolean())
            {
                // Session expired or credentials changed - prompt user to re-login
                requiresRelogin = true;
                if (result.TryGetProperty("friendlyMessage", out var friendlyMsg))
                {
                    consentErrorMessage = friendlyMsg.GetString();
                }
                else
                {
                    consentErrorMessage = "Your session has expired or your credentials have changed. Please sign out and sign in again.";
                }
                Console.WriteLine($"✗ Re-login required: {consentErrorMessage}");
            }
            else if (result.TryGetProperty("error", out var error))
            {
                var errorMsg = error.GetString() ?? "Unknown error";
                if (!errorMsg.Contains("user_cancelled"))
                {
                    consentErrorMessage = errorMsg;
                    Console.WriteLine($"✗ Consent failed: {consentErrorMessage}");
                }
                else
                {
                    Console.WriteLine("Consent cancelled by user");
                }
            }
        }
        catch (Exception ex)
        {
            consentErrorMessage = ex.Message;
            Console.WriteLine($"✗ Error during consent: {ex}");
        }
        finally
        {
            isGrantingArmConsent = false;
            StateHasChanged();
        }
    }

    private async Task LoadNamespacesAsync()
    {
        _loadCts?.Cancel();
        _loadCts = new CancellationTokenSource();
        var ct = _loadCts.Token;

        isRefreshing = true;
        errorMessage = null;

        try
        {
            var credential = await AuthService.GetTokenCredentialAsync();
            if (credential == null)
            {
                errorMessage = "Failed to get authentication token";
                isRefreshing = false;
                return;
            }

            await foreach (var ns in ResourceService.ListServiceBusNamespacesAsync(credential, ct))
            {
                if (ct.IsCancellationRequested) break;
                namespaceDict[ns.Name] = ns;
                StateHasChanged();
            }
            
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load namespaces: {ex.Message}";
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();
        }
    }

    private void NavigateToExplorer(ServiceBusNamespaceInfo ns)
    {
        var url = $"explorer?namespace={Uri.EscapeDataString(ns.FullyQualifiedNamespace)}&rg={Uri.EscapeDataString(ns.ResourceGroup)}&sub={Uri.EscapeDataString(ns.SubscriptionId)}&name={Uri.EscapeDataString(ns.Name)}";
        Navigation.NavigateTo(url);
    }

    private async Task ToggleFavorite(string fullyQualifiedNamespace)
    {
        var ns = namespaces.FirstOrDefault(n => n.FullyQualifiedNamespace == fullyQualifiedNamespace);
        if (ns == null) return;

        if (NavState.IsFavorite(fullyQualifiedNamespace))
        {
            await NavState.RemoveFromFavoritesAsync(fullyQualifiedNamespace);
        }
        else
        {
            var displayName = ns.Name.Replace(".servicebus.windows.net", "");
            await NavState.AddToFavoritesAsync(fullyQualifiedNamespace, ns.ResourceGroup, ns.SubscriptionId, displayName);
        }
    }

}
